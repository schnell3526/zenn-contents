---
title: "æ—¥æœ¬èªç‰ˆRoBERTaã‚’ä½¿ã†(Juman++ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•)"
emoji: "ğŸ³"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["è‡ªç„¶è¨€èªå‡¦ç†", "BERT", "python"]
published: true
---

BERTã®å¾Œç¶™ãƒ¢ãƒ‡ãƒ«ã§ã‚ã‚‹RoBERTaã®æ—¥æœ¬èªç‰ˆãŒæ—©ç¨²ç”°å¤§å­¦æ²³åŸç ”ç©¶å®¤ã‚ˆã‚Šå…¬é–‹ã•ã‚Œã¦ã„ã¾ã™ã€‚

---
<!-- :::details å…¬é–‹ãƒ¢ãƒ‡ãƒ«ã®ä¸€è¦§ -->
- RoBERTa-Base(ç³»åˆ—é•·:128)

https://huggingface.co/nlp-waseda/roberta-base-japanese

- RoBERTa-Learge(ç³»åˆ—é•·:128)

https://huggingface.co/nlp-waseda/roberta-large-japanese

- RoBERTa-Learge(ç³»åˆ—é•·:**512**)

https://huggingface.co/nlp-waseda/roberta-large-japanese-seq512
<!-- ::: -->

---


äº¬éƒ½å¤§å­¦é»’æ©‹ãƒ»è¤šãƒ»æ‘è„‡ç ”ç©¶å®¤ã‚„æ—©ç¨²ç”°å¤§å­¦æ²³åŸç ”ç©¶å®¤ã®å…¬é–‹ã™ã‚‹äº‹å‰å­¦ç¿’æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ã¯ã‚ˆãä½¿ã‚ã‚Œã‚‹ipadicç³»ã®mecabã§ã¯ãªãã€jumanè¾æ›¸ã‚’ç”¨ã„ãŸjuman++ã«ã¦å‰å‡¦ç†ãŒè¡Œã‚ã‚Œã¦ãŠã‚Šhuggingfaceç¤¾ã®æä¾›ã™ã‚‹tokenizer APIã§ã¯å‰å‡¦ç†ãŒè¡Œãˆã¾ã›ã‚“ã€‚
æœ¬è¨˜äº‹ã§ã¯juman++ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’å«ã‚ã¦ã€å…ˆè¿°ã®äº‹å‰å­¦ç¿’æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ãŒåˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã¾ã§ã®æ‰‹é †ã‚’èª¬æ˜ã—ã¾ã™ã€‚

# juman++ã«ã¤ã„ã¦
https://github.com/ku-nlp/jumanpp
ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰ã«å…¬é–‹ã•ã‚Œã¦ã„ã¾ã™ã®ã§è©³ã—ãã¯ã€ã“ã¡ã‚‰ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

## juman++ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

::: details macOS(intelç‰ˆ)ã®å ´åˆ
ã¾ãšã€ãƒ“ãƒ«ãƒ‰ãƒ„ãƒ¼ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’è¡Œã„ã¾ã™ã€‚
```shell
brew install cmake wget zlib
```

æ¬¡ã«ã‚½ãƒ¼ã‚¹ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦æ‰‹å…ƒç’°å¢ƒã§ãƒ“ãƒ«ãƒ‰&installã—ã¾ã™ã€‚
cmakeã®å®Ÿè¡Œæ™‚ã«`-DCMAKE_INSTALL_PREFIX="ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å…ˆ"`ã¨ãƒ•ãƒ©ã‚°ã‚’è¨­å®šã™ã‚‹ã“ã¨ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å…ˆã‚’è‡ªç”±ã«è¨­å®šã§ãã¾ã™ã€‚
```shell
wget "https://github.com/ku-nlp/jumanpp/releases/download/v2.0.0-rc3/jumanpp-2.0.0-rc3.tar.xz"
tar xvJf jumanpp-2.0.0-rc3.tar.xz

cd jumanpp-2.0.0-rc3
mkdir bld && cd bld
cmake .. -DCMAKE_BUILD_TYPE=Release
sudo make install -j $(getconf _NPROCESSORS_ONLN)
```
ä»¥ä¸Šã§juman++ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¯å®Œäº†ã—ã¾ã™ã€‚
```shell
jumanpp -v
# Juman++ Version: 2.0.0-rc3
```
:::

:::details M1 Macã®å ´åˆ
```shell
wget "https://github.com/ku-nlp/jumanpp/releases/download/v2.0.0-rc3/jumanpp-2.0.0-rc3.tar.xz"
tar xvJf jumanpp-2.0.0-rc3.tar.xz

cd jumanpp-2.0.0-rc3
mkdir bld && cd bld

cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/Users/ãƒ¦ãƒ¼ã‚¶ãƒ¼å/nlp/opt/jumanpp
```

ã“ã®ã¾ã¾makeã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ãƒ“ãƒ«ãƒ‰ã‚’è¡Œã†ã¨ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã®ã§ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãæ›ãˆã‚‹ã€‚`libs/backward.hpp`ã®2267,2268è¡Œä»˜è¿‘ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«æ”¹å¤‰ã™ã‚‹ã€‚
```c:libs/backward.hpp
// #elif defined(__aarch64__)
//     error_addr = reinterpret_cast<void*>(uctx->uc_mcontext.pc);
#elif defined(__aarch64__)
    #if defined(__APPLE__)
      error_addr = reinterpret_cast<void *>(uctx->uc_mcontext->__ss.__pc);
    #else
      error_addr = reinterpret_cast<void *>(uctx->uc_mcontext.pc);
    #endif
```

ã¾ãŸ, `libs/catch.hpp`ã‚’æœ€æ–°ã«ã™ã‚‹ã€‚
```shell
curl -LO https://github.com/catchorg/Catch2/releases/download/v2.13.8/catch.hpp
mv catch.hpp ../libs/
```

æ”¹å¤‰å¾Œmakeã‚’å®Ÿè¡Œã—ãƒ“ãƒ«ãƒ‰ã‚’è¡Œã†
```shell
make -j $(getconf _NPROCESSORS_ONLN)
make install
```
:::

:::details Linux(debianç³»)ã®å ´åˆ
å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä¸€é€šã‚Šã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
```shel
sudo apt update -q
sudo apt install -qy cmake g++ make wget xz-utils
```

ã‚½ãƒ¼ã‚¹ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
```shell
wget "https://github.com/ku-nlp/jumanpp/releases/download/v2.0.0-rc3/jumanpp-2.0.0-rc3.tar.xz"
tar xvf jumanpp-2.0.0-rc3.tar.xz
```

ã‚½ãƒ¼ã‚¹ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
```shell
cd jumanpp-2.0.0-rc3
mkdir bld && cd bld

curl -LO https://github.com/catchorg/Catch2/releases/download/v2.13.8/catch.hpp
mv catch.hpp ../libs/
cmake .. -DCMAKE_BUILD_TYPE=Release
sudo make install -j "$(nproc)"
sudo make install
```
:::

## ç°¡å˜ãªä½¿ã„æ–¹
æ¨™æº–å…¥åŠ›ã«è§£æã—ãŸã„æ–‡å­—åˆ—ã‚’æµã—è¾¼ã‚€ã“ã¨ã§å½¢æ…‹ç´ è§£æãŒè¡Œãˆã¾ã™ã€‚
```shell
echo "å½¢æ…‹ç´ è§£æå™¨ã‚’ä½¿ã£ã¦ã¿ã‚‹ã€‚" | jumanpp
# å½¢æ…‹ ã‘ã„ãŸã„ å½¢æ…‹ åè© 6 æ™®é€šåè© 1 * 0 * 0 "ä»£è¡¨è¡¨è¨˜:å½¢æ…‹/ã‘ã„ãŸã„ ã‚«ãƒ†ã‚´ãƒª:å½¢ãƒ»æ¨¡æ§˜"
# ç´  ã ç´  åè© 6 æ™®é€šåè© 1 * 0 * 0 "ä»£è¡¨è¡¨è¨˜:ç´ /ã ã‚«ãƒ†ã‚´ãƒª:æŠ½è±¡ç‰© æ¼¢å­—èª­ã¿:éŸ³"
# è§£æ ã‹ã„ã›ã è§£æ åè© 6 ã‚µå¤‰åè© 2 * 0 * 0 "ä»£è¡¨è¡¨è¨˜:è§£æ/ã‹ã„ã›ã ãƒ‰ãƒ¡ã‚¤ãƒ³:æ•™è‚²ãƒ»å­¦ç¿’;ç§‘å­¦ãƒ»æŠ€è¡“ ã‚«ãƒ†ã‚´ãƒª:æŠ½è±¡ç‰©"
# å™¨ ã å™¨ åè© 6 æ™®é€šåè© 1 * 0 * 0 "ä»£è¡¨è¡¨è¨˜:å™¨/ã ã‚«ãƒ†ã‚´ãƒª:äººå·¥ç‰©-ãã®ä»– æ¼¢å­—èª­ã¿:éŸ³"
# ã‚’ ã‚’ ã‚’ åŠ©è© 9 æ ¼åŠ©è© 1 * 0 * 0 NIL
# ä½¿ã£ã¦ ã¤ã‹ã£ã¦ ä½¿ã† å‹•è© 2 * 0 å­éŸ³å‹•è©ãƒ¯è¡Œ 12 ã‚¿ç³»é€£ç”¨ãƒ†å½¢ 14 "ä»£è¡¨è¡¨è¨˜:ä½¿ã†/ã¤ã‹ã†"
# ã¿ã‚‹ ã¿ã‚‹ ã¿ã‚‹ æ¥å°¾è¾ 14 å‹•è©æ€§æ¥å°¾è¾ 7 æ¯éŸ³å‹•è© 1 åŸºæœ¬å½¢ 2 "ä»£è¡¨è¡¨è¨˜:ã¿ã‚‹/ã¿ã‚‹"
# ã€‚ ã€‚ ã€‚ ç‰¹æ®Š 1 å¥ç‚¹ 1 * 0 * 0 NIL
# EOS
```
æ·±å±¤å­¦ç¿’ç”¨é€”ã§ã¯å˜èªåˆ†å‰²ãŒã§ãã‚Œã°è‰¯ã„ã®ã§ã€ãã®éš›ã¯`--segment`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã¤ã‘ã¦ãã ã•ã„ã€‚
```shell
echo "å½¢æ…‹ç´ è§£æå™¨ã‚’ä½¿ã£ã¦ã¿ã‚‹ã€‚" | jumanpp --segment
# å½¢æ…‹ ç´  è§£æ å™¨ ã‚’ ä½¿ã£ã¦ ã¿ã‚‹ ã€‚
```
ãƒ•ã‚¡ã‚¤ãƒ«ã”ã¨å‡¦ç†ã‚’ã™ã‚‹å ´åˆã¯
```shel
jumanpp --segment -o "å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«" "å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«"
```
ã¨å®Ÿè¡Œã™ã‚‹ã“ã¨ã§å‡¦ç†ãŒã§ãã¾ã™ã€‚ã•ã‚‰ã«è©³ã—ãã¯å…ˆè¿°ã®ãƒªãƒã‚¸ãƒˆãƒªã‚„ã€`-h`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ã£ã¦ç¢ºèªã—ã¦ãã ã•ã„ã€‚

:::details è§£æé€Ÿåº¦ã«é–¢ã™ã‚‹æ¯”è¼ƒ
æœ‰åãªMeCabã¨æ¯”ã¹ã‚‹ã¨ç²¾åº¦ã«ã¯å‹ã‚‹ä¸€æ–¹ã§è§£æé€Ÿåº¦ã¯åŠ£ã‚Šã¾ã™ã€‚NLP100æœ¬ãƒãƒƒã‚¯ã®ã€Œå¾è¼©ã¯çŒ«ã§ã‚ã‚‹ã€ã‚’è§£æã™ã‚‹é€Ÿåº¦ã‚’ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã¨ã—ã¦è§£æé€Ÿåº¦ã®è¨ˆæ¸¬ã‚’è¡Œãªã£ã¦ã¿ã¾ã™ã€‚

```shell
wget https://nlp100.github.io/data/neko.txt
wc -l neko.txt
    # 9964 neko.txt
time mecab -Owakati neko.txt > /dev/null
# mecab -Owakati neko.txt > /dev/null  0.07s user 0.01s system 97% cpu 0.075 total
time jumanpp --segment neko.txt > /dev/null
# jumanpp --segment neko.txt > /dev/null  1.73s user 0.10s system 68% cpu 2.656 total
```
mecabã®æ–¹ãŒ60å€æ—©ã„çµæœã¨ãªã‚Šã¾ã—ãŸãŒã€jumanppã®å ´åˆå‘¼ã³å‡ºã—ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ãŒå¤§ãã„ã®ã§å¤§ããªãƒ†ã‚­ã‚¹ãƒˆã‚’è§£æã™ã‚‹å ´åˆã¯10å€ç¨‹åº¦ã®é€Ÿåº¦å·®ã«ãªã‚Šã¾ã™ã€‚l

:::

# ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
transformersã¯ã‚‚ã¡ã‚ã‚“ã„ãã¤ã‹ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ãªã„ã¨ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¾ã™ã€‚
```shell
pip install torch
pip install git+https://github.com/huggingface/transformers
pip install sentencepiece
pip install protobuff
```
ã“ã‚Œã§æº–å‚™ãŒæ•´ã„ã¾ã—ãŸã€‚

# è©¦ã—ã¦ã¿ã‚‹
"æ—¥æœ¬èªã®è‡ªç„¶è¨€èªå‡¦ç†ã¯é›£ã—ã„ ã€‚"ã¨ã„ã†æ–‡å­—åˆ—ã‚’è§£æã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
```shell
echo "æ—¥æœ¬èªã®è‡ªç„¶è¨€èªå‡¦ç†ã¯é›£ã—ã„ã€‚" | jumanpp --segment
# æ—¥æœ¬ èª ã® è‡ªç„¶ è¨€èª å‡¦ç† ã¯ é›£ã—ã„ ã€‚
```
"é›£ã—ã„"ã¨ã„ã†ãƒˆãƒ¼ã‚¯ãƒ³ã‚’[MASK]ã«ç½®ãå¤‰ãˆã¦ã€å…ˆã»ã©ç´¹ä»‹ã—ãŸæ—©å¤§robertaã§ãƒˆãƒ¼ã‚¯ãƒ³ã®äºˆæ¸¬ã‚’ã—ã¦ã¿ã¾ã™ã€‚ã¾ãšã¯åˆ©ç”¨ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚„äº‹å‰å­¦ç¿’æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ã®èª­ã¿è¾¼ã¿ã‚’è¡Œã„ã¾ã™ã€‚

```python
import torch
from transformers import AutoTokenizer, AutoModelForMaskedLM
tokenizer = AutoTokenizer.from_pretrained("nlp-waseda/roberta-base-japanese")
model = AutoModelForMaskedLM.from_pretrained("nlp-waseda/roberta-base-japanese")
```

æ¬¡ã«maskãƒˆãƒ¼ã‚¯ãƒ³ã®äºˆæ¸¬ã§ã™ã€‚Huggingfaceç¤¾ã®æä¾›ã™ã‚‹[Pipelines API](https://huggingface.co/docs/transformers/v4.15.0/en/main_classes/pipelines#transformers.FillMaskPipeline)ã‚’ä½¿ãˆã°ã‚‚ã£ã¨ç°¡å˜ã«å®Ÿç¾ã§ãã¾ã™ãŒã€ä»Šå›ã¯ã‚¹ã‚¯ãƒ©ãƒƒãƒã§å‡¦ç†ã‚’è¨˜è¿°ã—ã¾ã™ã€‚
```python
# maskã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ä½ç½®ã‚’å–å¾—ã™ã‚‹
def get_masked_index(encoding):
    for idx, id in enumerate(encoding.input_ids.squeeze(0)):
        if id == tokenizer.mask_token_id:
            return idx

# å…¥åŠ›ç³»åˆ—ã®å‡¦ç†
sentence = 'æ—¥æœ¬ èª ã® è‡ªç„¶ è¨€èª å‡¦ç† ã¯ [MASK] ã€‚'
encoding = tokenizer(sentence, return_tensors='pt')

# äºˆæ¸¬
pred = model(**encoding)

# å¾Œå‡¦ç†(å–å¾—ã—ãŸäºˆæ¸¬åˆ†å¸ƒã‹ã‚‰ã€maskãƒˆãƒ¼ã‚¯ãƒ³ã®ä¸Šä½kä»¶ã®äºˆæ¸¬çµæœã‚’å–å¾—)
masked_idx = get_masked_index(encoding)
target_probs = pred.logits.squeeze(0)[masked_idx]

# ä¸Šä½kä»¶ã®äºˆæ¸¬çµæœã‚’ã®indexã‚’å–å¾—
top_k = torch.topk(target_probs, k=5).indices
for id in top_k:
    print(sentence.replace("[MASK]", f"'{tokenizer.decode(id)}'"))
# æ—¥æœ¬ èª ã® è‡ªç„¶ è¨€èª å‡¦ç† ã¯ 'å¾—æ„' ã€‚
# æ—¥æœ¬ èª ã® è‡ªç„¶ è¨€èª å‡¦ç† ã¯ 'ã§ãã‚‹' ã€‚
# æ—¥æœ¬ èª ã® è‡ªç„¶ è¨€èª å‡¦ç† ã¯ 'å°‚é–€' ã€‚
# æ—¥æœ¬ èª ã® è‡ªç„¶ è¨€èª å‡¦ç† ã¯ 'ãªã„' ã€‚
# æ—¥æœ¬ èª ã® è‡ªç„¶ è¨€èª å‡¦ç† ã¯ 'è‹¦æ‰‹' ã€‚
```

æ—©å¤§robertaã«ã‚ˆã‚‹ã¨æ—¥æœ¬èªã®è‡ªç„¶è¨€èªå‡¦ç†ã¯"å¾—æ„"ã ãã†ã§ã™ã€‚
juman++ã§å‰å‡¦ç†ãŒã•ã‚Œã¦ã„ã‚‹ã“ã¨ã§äº›ã‹ç™–ãŒã‚ã‚‹ã¨è¨€ãˆã‚‹æ—©å¤§robertaã§ã™ãŒã€æ—¥æœ¬èªwikipediaã¨ã€CC-100ã®æ—¥æœ¬èªéƒ¨åˆ†ã§å­¦ç¿’ã•ã‚Œã¦ãŠã‚Šæ—¢å­˜ã®äº‹å‰å­¦ç¿’æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ã‚ˆã‚Šå·¨å¤§ãªã‚³ãƒ¼ãƒ‘ã‚¹ã‚’ç”¨ã„ã¦å­¦ç¿’ã•ã‚Œã¦ã„ã‚‹ç‚¹ãŒå¼·ã¿ã‹ã¨æ€ã„ã¾ã™ã€‚
ãªãŠã€ã“ã®ãƒ¢ãƒ‡ãƒ«ã¯è©¦é¨“çš„ãªå…¬é–‹ã¨ã„ã†ã“ã¨ã§å­¦ç¿’æ™‚ã®æœ€å¤§ç³»åˆ—é•·ãŒ128ã«ãªã£ã¦ã„ã¾ã™(å¤§æŠµã¯512)ã®ã§å„ã‚¿ã‚¹ã‚¯ã«fine-tuningã‚’ã™ã‚‹éš›ãªã©ã¯æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚

# çµ‚ã‚ã‚Šã«
ã¾ãŸæ—©å¤§æ²³åŸç ”ç©¶å®¤ã§ã¯æ—¥æœ¬èªç‰ˆã®GLUEãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯(JGLUE)ãŒä½œæˆã•ã‚Œã¦ãŠã‚Šè¿‘ã„ã†ã¡ã«ãã®ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯çµæœã‚‚[å…¬é–‹](https://huggingface.co/nlp-waseda/roberta-base-japanese#performance-on-jglue)ã•ã‚Œã‚‹ã¨ã®ã“ã¨ã§ã™ã€‚
æ—¥æœ¬èªã®è‡ªç„¶è¨€èªå‡¦ç†ã®ã•ã‚‰ãªã‚‹ç™ºå±•ã‚’æœŸå¾…ã—ã¾ã—ã‚‡ã†ã€‚

::: message
2022/07/17è¿½è¨˜

JGLUEã®ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ãŒå…¬é–‹ã•ã‚Œã¾ã—ãŸã®ã§ãƒªãƒ³ã‚¯ã‚’è¿½è¨˜ã—ã¾ã™ã€‚
https://github.com/yahoojapan/JGLUE
:::